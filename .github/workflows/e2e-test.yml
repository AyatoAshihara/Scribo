# Scribo E2E ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æœ¬ç•ªAWSç’°å¢ƒã‚’ä½¿ç”¨ã—ãŸçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆæ‰‹å‹•å®Ÿè¡Œï¼‰
#
# âš ï¸ æ³¨æ„äº‹é …:
# - æœ¬ç•ªDynamoDBã¨Bedrockã‚’ä½¿ç”¨ã—ã¾ã™
# - Bedrockã®å‘¼ã³å‡ºã—ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™
# - é‡è¦ãªãƒªãƒªãƒ¼ã‚¹å‰ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨

name: E2E Tests

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      skip_scoring_test:
        description: 'æŽ¡ç‚¹E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆBedrockã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰'
        required: false
        default: 'false'
        type: boolean
      test_marker:
        description: 'å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒžãƒ¼ã‚«ãƒ¼ï¼ˆe2e, e2e_scoring, e2e_answersï¼‰'
        required: false
        default: 'e2e'
        type: string

env:
  AWS_REGION: ap-northeast-1

jobs:
  e2e-test:
    name: E2E Tests (Production AWS)
    runs-on: ubuntu-latest
    
    # OIDCèªè¨¼ã§AWSã«ã‚¢ã‚¯ã‚»ã‚¹
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::058264261094:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        working-directory: ./app
        run: |
          pip install -r requirements.txt

      - name: Run E2E tests (Answers only)
        if: ${{ inputs.skip_scoring_test == 'true' }}
        working-directory: ./app
        run: |
          pytest tests/e2e -v -m e2e_answers --tb=short
        env:
          AWS_REGION: ap-northeast-1
          DYNAMODB_EXAM_TABLE: scribo-ipa
          DYNAMODB_SUBMISSION_TABLE: SubmissionTable
          BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20240620-v1:0

      - name: Run E2E tests (Full)
        if: ${{ inputs.skip_scoring_test != 'true' }}
        working-directory: ./app
        run: |
          pytest tests/e2e -v -m ${{ inputs.test_marker }} --tb=short
        env:
          AWS_REGION: ap-northeast-1
          DYNAMODB_EXAM_TABLE: scribo-ipa
          DYNAMODB_SUBMISSION_TABLE: SubmissionTable
          BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20240620-v1:0

      - name: E2E Test Summary
        if: always()
        run: |
          echo "## ðŸ”¬ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Marker:** ${{ inputs.test_marker }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Scoring:** ${{ inputs.skip_scoring_test }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AWS Resources Used" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB: scribo-ipa, SubmissionTable" >> $GITHUB_STEP_SUMMARY
          echo "- Bedrock: Claude 3.5 Sonnet" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **æ³¨æ„:** E2Eãƒ†ã‚¹ãƒˆã¯æœ¬ç•ªAWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
