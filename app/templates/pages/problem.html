{% extends "base.html" %}

{% block timer %}
<!-- タイマーコンポーネント（Alpine.js） -->
<div x-data="examTimer({{ 120 }})" x-init="init()" class="flex items-center gap-2">
    <template x-if="!isRunning && remainingSeconds === totalSeconds">
        <button @click="start()" class="btn btn-sm btn-accent text-white gap-1 rounded-xl">
            ⏱️ タイマー開始
            <div class="tooltip tooltip-bottom" data-tip="120分のタイマーで本番と同じ時間配分で練習できます">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
        </button>
    </template>
    
    <template x-if="isRunning || remainingSeconds < totalSeconds">
        <div class="flex items-center gap-2">
            <div 
                class="px-3 py-1 rounded-xl font-mono text-lg font-semibold"
                :class="{
                    'bg-error/20 text-error animate-pulse': remainingSeconds <= 300,
                    'bg-warning/20 text-warning': remainingSeconds > 300 && remainingSeconds <= 600,
                    'bg-info/20 text-info': remainingSeconds > 600
                }">
                <span x-text="formatTime(remainingSeconds)"></span>
            </div>
            <button 
                @click="toggle()" 
                class="btn btn-sm btn-ghost rounded-xl"
                x-text="isRunning ? '⏸️' : '▶️'">
            </button>
            <button @click="reset()" class="btn btn-sm btn-ghost rounded-xl">🔄</button>
        </div>
    </template>
</div>
{% endblock %}

{% block content %}
<div 
    x-data="problemViewer('{{ exam_type }}', '{{ problem_id }}')" 
    x-init="init()"
    class="h-[calc(100vh-12rem)]">
    
    <!-- ローディング状態 -->
    <template x-if="loading">
        <div class="flex justify-center items-center h-full">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </template>
    
    <!-- エラー状態 -->
    <template x-if="error">
        <div class="alert-soft-error">
            <span x-text="error"></span>
            <a href="/" class="btn btn-sm rounded-xl">一覧に戻る</a>
        </div>
    </template>
    
    <!-- メインコンテンツ -->
    <template x-if="!loading && !error && problem">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            <!-- 左カラム: 問題文 -->
            <div class="card-modern overflow-hidden">
                <div class="card-body p-0 h-full flex flex-col">
                    <div class="p-4 border-b border-base-200 bg-base-100/50 flex justify-between items-start">
                        <div>
                            <h2 class="card-title text-lg" x-text="problem.title"></h2>
                            <p class="text-sm text-base-content/70" x-text="problem.year_term"></p>
                        </div>
                        <!-- ヘルプボタン -->
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-circle btn-ghost btn-sm hover:bg-base-200">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"></path></svg>
                            </label>
                            <div tabindex="0" class="dropdown-content z-[100] card card-compact shadow-xl bg-base-100 w-72 rounded-2xl border border-base-200">
                                <div class="card-body">
                                    <h3 class="card-title text-sm">💡 論述のコツ</h3>
                                    <ul class="text-xs space-y-2 text-base-content/80">
                                        <li class="flex gap-2">
                                            <span>📖</span>
                                            <span>問題文を最後まで読み、要求を把握する</span>
                                        </li>
                                        <li class="flex gap-2">
                                            <span>🎯</span>
                                            <span>設問ごとに「何を答えるか」を明確に</span>
                                        </li>
                                        <li class="flex gap-2">
                                            <span>✍️</span>
                                            <span>具体的な数値・事例を盛り込む</span>
                                        </li>
                                        <li class="flex gap-2">
                                            <span>⏰</span>
                                            <span>設問アに30分、イに50分、ウに40分が目安</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="prose prose-sm max-w-none prose-base-content" x-html="formatContent(problem.problem_content)"></div>
                        
                        <!-- 設問一覧 -->
                        <div class="divider">設問</div>
                        <template x-for="(content, key) in problem.problem_question" :key="key">
                            <div class="mb-4 p-4 bg-base-200/50 rounded-xl border border-base-200">
                                <h4 class="font-bold text-primary" x-text="key"></h4>
                                <p class="text-sm mt-1" x-text="content"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- 右カラム: 回答入力 -->
            <div class="card-modern overflow-hidden">
                <div class="card-body p-0 h-full flex flex-col">
                    <!-- ヘッダーとヘルプ -->
                    <div class="px-4 pt-3 flex justify-between items-center">
                        <span class="text-sm font-semibold text-base-content/70">回答入力</span>
                        <div class="tooltip tooltip-left" data-tip="回答は自動保存されます。ページを離れても続きから再開できます。">
                            <span class="badge-soft-success text-xs gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-3 h-3 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                自動保存
                            </span>
                        </div>
                    </div>
                    
                    <!-- 全体進捗バー -->
                    <div class="px-4 pt-2">
                        <div class="flex gap-1 mb-1">
                            <template x-for="q in ['設問ア', '設問イ', '設問ウ']" :key="q">
                                <div 
                                    class="flex-1 h-2 rounded-full transition-all duration-500"
                                    :class="isQuestionComplete(q) ? 'bg-success' : 'bg-base-300'">
                                </div>
                            </template>
                        </div>
                        <p class="text-xs text-center text-base-content/60">
                            <span x-text="getCompletedCount()"></span>/3 設問完了
                        </p>
                    </div>
                    
                    <!-- タブ -->
                    <div class="tabs tabs-bordered bg-base-100/50 p-2 border-b border-base-200">
                        <template x-for="(_, key) in answers" :key="key">
                            <button 
                                @click="activeTab = key"
                                :class="activeTab === key ? 'tab tab-active text-primary font-semibold' : 'tab text-base-content'"
                                class="tab gap-2 transition-all">
                                <span x-text="key"></span>
                                <!-- 完了チェックマーク -->
                                <span 
                                    x-show="isQuestionComplete(key)"
                                    class="text-success text-lg"
                                    x-transition:enter="transition ease-out duration-300"
                                    x-transition:enter-start="opacity-0 scale-50"
                                    x-transition:enter-end="opacity-100 scale-100">✓</span>
                                <span 
                                    class="badge badge-sm font-medium"
                                    :class="getWordCountBadgeClass(key)"
                                    x-text="getWordCount(key) + '字'">
                                </span>
                            </button>
                        </template>
                    </div>
                    
                    <!-- 回答入力エリア -->
                    <div class="flex-1 p-4 flex flex-col">
                        <template x-for="(_, key) in answers" :key="key">
                            <div x-show="activeTab === key" class="flex-1 flex flex-col">
                                <!-- 文字数ガイド -->
                                <div class="flex justify-between items-center mb-2 text-sm">
                                    <span class="text-base-content/70">
                                        目安: <span x-text="getWordLimit(key)" class="text-base-content"></span>
                                    </span>
                                    <span 
                                        :class="getWordCountBadgeClass(key)"
                                        class="font-mono text-base-content">
                                        <span x-text="getWordCount(key)"></span> 文字
                                    </span>
                                </div>
                                
                                <!-- あと○文字メッセージ / 達成メッセージ -->
                                <div class="mb-2 text-center">
                                    <template x-if="getRemainingWords(key) > 0">
                                        <span class="text-sm text-warning font-medium animate-pulse">
                                            🎯 あと <span x-text="getRemainingWords(key)" class="font-bold"></span> 文字で目標達成！
                                        </span>
                                    </template>
                                    <template x-if="getRemainingWords(key) <= 0 && !isOverLimit(key)">
                                        <span 
                                            class="text-sm text-success font-medium"
                                            x-transition:enter="transition ease-out duration-500"
                                            x-transition:enter-start="opacity-0 transform scale-90"
                                            x-transition:enter-end="opacity-100 transform scale-100">
                                            🎉 目標達成！素晴らしい！
                                        </span>
                                    </template>
                                    <template x-if="isOverLimit(key)">
                                        <span class="text-sm text-error font-medium">
                                            ⚠️ <span x-text="getOverWords(key)"></span> 文字オーバー（要調整）
                                        </span>
                                    </template>
                                </div>
                                
                                <!-- テキストエリア -->
                                <textarea 
                                    x-model="answers[key]"
                                    @input="saveToLocalStorage()"
                                    class="textarea textarea-bordered flex-1 w-full resize-none font-mono text-sm leading-relaxed"
                                    :placeholder="key + 'の回答を入力してください...'">
                                </textarea>
                            </div>
                        </template>
                    </div>
                    
                    <!-- 送信ボタン -->
                    <div class="p-4 border-t border-base-200 bg-base-100/50">
                        <p class="text-xs text-base-content/60 mb-3 text-center">
                            💡 送信後、AIが8つの観点であなたの回答を評価します（約60-90秒）
                        </p>
                        <button 
                            @click="submitAnswer()"
                            :disabled="submitting"
                            class="btn-gradient w-full">
                            <template x-if="submitting">
                                <span class="loading loading-spinner loading-sm"></span>
                            </template>
                            <span x-text="submitting ? '送信中...' : '回答を送信して採点'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- 時間切れダイアログ -->
<dialog id="timeup-dialog" class="modal">
    <div class="modal-box rounded-2xl">
        <h3 class="font-bold text-lg">⏰ 制限時間終了</h3>
        <p class="py-4">試験時間が終了しました。回答を送信しますか？</p>
        <div class="modal-action">
            <button class="btn btn-ghost rounded-xl" onclick="document.getElementById('timeup-dialog').close()">
                続ける
            </button>
            <button class="btn-gradient" onclick="Alpine.store('problem').submitAnswer()">
                送信する
            </button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script src="/static/js/problem.js"></script>
{% endblock %}
