{% extends "base.html" %}

{% block timer %}
<!-- „Çø„Ç§„Éû„Éº„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàAlpine.jsÔºâ -->
<div x-data="examTimer({{ 120 }})" x-init="init()" class="flex items-center gap-2">
    <template x-if="!isRunning && remainingSeconds === totalSeconds">
        <button @click="start()" class="btn btn-sm btn-accent">
            ‚è±Ô∏è „Çø„Ç§„Éû„ÉºÈñãÂßã
        </button>
    </template>
    
    <template x-if="isRunning || remainingSeconds < totalSeconds">
        <div class="flex items-center gap-2">
            <div 
                class="badge badge-lg font-mono text-lg"
                :class="{
                    'badge-error animate-pulse': remainingSeconds <= 300,
                    'badge-warning': remainingSeconds > 300 && remainingSeconds <= 600,
                    'badge-info': remainingSeconds > 600
                }">
                <span x-text="formatTime(remainingSeconds)"></span>
            </div>
            <button 
                @click="toggle()" 
                class="btn btn-sm btn-ghost"
                x-text="isRunning ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'">
            </button>
            <button @click="reset()" class="btn btn-sm btn-ghost">üîÑ</button>
        </div>
    </template>
</div>
{% endblock %}

{% block content %}
<div 
    x-data="problemViewer('{{ exam_type }}', '{{ problem_id }}')" 
    x-init="init()"
    class="h-[calc(100vh-12rem)]">
    
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã -->
    <template x-if="loading">
        <div class="flex justify-center items-center h-full">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </template>
    
    <!-- „Ç®„É©„ÉºÁä∂ÊÖã -->
    <template x-if="error">
        <div class="alert alert-error">
            <span x-text="error"></span>
            <a href="/" class="btn btn-sm">‰∏ÄË¶ß„Å´Êàª„Çã</a>
        </div>
    </template>
    
    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <template x-if="!loading && !error && problem">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            <!-- Â∑¶„Ç´„É©„É†: ÂïèÈ°åÊñá -->
            <div class="card bg-base-100 shadow-lg overflow-hidden">
                <div class="card-body p-0 h-full flex flex-col">
                    <div class="p-4 border-b bg-base-200">
                        <h2 class="card-title text-lg" x-text="problem.title"></h2>
                        <p class="text-sm text-base-content/70" x-text="problem.year_term"></p>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="prose prose-sm max-w-none" x-html="formatContent(problem.problem_content)"></div>
                        
                        <!-- Ë®≠Âïè‰∏ÄË¶ß -->
                        <div class="divider">Ë®≠Âïè</div>
                        <template x-for="(content, key) in problem.problem_question" :key="key">
                            <div class="mb-4 p-3 bg-base-200 rounded-lg">
                                <h4 class="font-bold" x-text="key"></h4>
                                <p class="text-sm mt-1" x-text="content"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Âè≥„Ç´„É©„É†: ÂõûÁ≠îÂÖ•Âäõ -->
            <div class="card bg-base-100 shadow-lg overflow-hidden">
                <div class="card-body p-0 h-full flex flex-col">
                    <!-- „Çø„Éñ -->
                    <div class="tabs tabs-bordered bg-base-200 p-2">
                        <template x-for="(_, key) in answers" :key="key">
                            <button 
                                @click="activeTab = key"
                                :class="activeTab === key ? 'tab tab-active' : 'tab'"
                                class="tab gap-2">
                                <span x-text="key"></span>
                                <span 
                                    class="badge badge-sm"
                                    :class="getWordCountBadgeClass(key)"
                                    x-text="getWordCount(key) + 'Â≠ó'">
                                </span>
                            </button>
                        </template>
                    </div>
                    
                    <!-- ÂõûÁ≠îÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                    <div class="flex-1 p-4 flex flex-col">
                        <template x-for="(_, key) in answers" :key="key">
                            <div x-show="activeTab === key" class="flex-1 flex flex-col">
                                <!-- ÊñáÂ≠óÊï∞„Ç¨„Ç§„Éâ -->
                                <div class="flex justify-between items-center mb-2 text-sm">
                                    <span class="text-base-content/70">
                                        ÁõÆÂÆâ: <span x-text="getWordLimit(key)"></span>
                                    </span>
                                    <span 
                                        :class="getWordCountBadgeClass(key)"
                                        class="font-mono">
                                        <span x-text="getWordCount(key)"></span> ÊñáÂ≠ó
                                    </span>
                                </div>
                                
                                <!-- „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ -->
                                <textarea 
                                    x-model="answers[key]"
                                    @input="saveToLocalStorage()"
                                    class="textarea textarea-bordered flex-1 w-full resize-none font-mono text-sm leading-relaxed"
                                    :placeholder="key + '„ÅÆÂõûÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...'">
                                </textarea>
                            </div>
                        </template>
                    </div>
                    
                    <!-- ÈÄÅ‰ø°„Éú„Çø„É≥ -->
                    <div class="p-4 border-t bg-base-200">
                        <button 
                            @click="submitAnswer()"
                            :disabled="submitting"
                            class="btn btn-primary w-full">
                            <template x-if="submitting">
                                <span class="loading loading-spinner loading-sm"></span>
                            </template>
                            <span x-text="submitting ? 'ÈÄÅ‰ø°‰∏≠...' : 'ÂõûÁ≠î„ÇíÈÄÅ‰ø°„Åó„Å¶Êé°ÁÇπ'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- ÊôÇÈñìÂàá„Çå„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
<dialog id="timeup-dialog" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">‚è∞ Âà∂ÈôêÊôÇÈñìÁµÇ‰∫Ü</h3>
        <p class="py-4">Ë©¶È®ìÊôÇÈñì„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÂõûÁ≠î„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü</p>
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('timeup-dialog').close()">
                Á∂ö„Åë„Çã
            </button>
            <button class="btn btn-primary" onclick="Alpine.store('problem').submitAnswer()">
                ÈÄÅ‰ø°„Åô„Çã
            </button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block scripts %}
<script src="/static/js/timer.js"></script>
<script src="/static/js/problem.js"></script>
{% endblock %}
