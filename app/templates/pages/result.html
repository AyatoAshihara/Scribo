{% extends "base.html" %}

{% block head %}
<!-- Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„ÉàÁî® -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
{% endblock %}

{% block content %}
<div 
    x-data="scoringResult('{{ submission_id }}')" 
    x-init="init()"
    class="max-w-4xl mx-auto">
    
    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÔºàÂä¥ÂÉç„ÅÆÈåØË¶öÔºâ -->
    <template x-if="loading">
        <div class="flex flex-col justify-center items-center py-16">
            <!-- „Çπ„ÉÜ„ÉÉ„ÉóË°®Á§∫ -->
            <ul class="steps steps-vertical lg:steps-horizontal mb-8">
                <li class="step" :class="loadingStep >= 1 ? 'step-primary' : ''">
                    <span class="text-sm">ÂõûÁ≠îÂèó‰ø°</span>
                </li>
                <li class="step" :class="loadingStep >= 2 ? 'step-primary' : ''">
                    <span class="text-sm">ÊñáÁ´†ÊßãÊàêÂàÜÊûê</span>
                </li>
                <li class="step" :class="loadingStep >= 3 ? 'step-primary' : ''">
                    <span class="text-sm">8Ë¶≥ÁÇπË©ï‰æ°</span>
                </li>
                <li class="step" :class="loadingStep >= 4 ? 'step-primary' : ''">
                    <span class="text-sm">„Çπ„Ç≥„Ç¢Ë®àÁÆó</span>
                </li>
            </ul>
            
            <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
            <div class="w-64 mb-4">
                <progress 
                    class="progress progress-primary w-full" 
                    :value="loadingProgress" 
                    max="100">
                </progress>
            </div>
            
            <!-- „Çπ„ÉÜ„ÉÉ„Éó„É°„ÉÉ„Çª„Éº„Ç∏ -->
            <p class="text-base-content/70 text-center" x-text="loadingMessage"></p>
            
            <!-- Ë±ÜÁü•Ë≠ò -->
            <div class="mt-8 p-4 bg-base-100 rounded-lg max-w-md">
                <p class="text-sm text-base-content/60">
                    üí° <span x-text="currentTip"></span>
                </p>
            </div>
        </div>
    </template>
    
    <!-- „Ç®„É©„ÉºÁä∂ÊÖã -->
    <template x-if="error">
        <div class="alert alert-error">
            <span x-text="error"></span>
            <a href="/" class="btn btn-sm">‰∏ÄË¶ß„Å´Êàª„Çã</a>
        </div>
    </template>
    
    <!-- Êé°ÁÇπÁµêÊûú -->
    <template x-if="!loading && !error && result">
        <div class="space-y-6">
            <!-- „Éò„ÉÉ„ÉÄ„Éº -->
            <div class="text-center">
                <h1 class="text-3xl font-bold mb-2">Êé°ÁÇπÁµêÊûú</h1>
                <p class="text-base-content/70" x-text="'ÊèêÂá∫ID: ' + submission_id"></p>
            </div>
            
            <!-- Á∑èÂêà„Çπ„Ç≥„Ç¢„Ç´„Éº„ÉâÔºàÊÆµÈöéÁöÑÈñãÁ§∫Ôºâ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body items-center text-center">
                    <!-- „É©„É≥„ÇØË°®Á§∫Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ -->
                    <div 
                        class="radial-progress text-6xl font-bold transition-all duration-1000"
                        :class="getRankColorClass(result.final_rank)"
                        :style="'--value:' + (showDetails ? result.aggregate_score : 0) + '; --size: 12rem; --thickness: 1rem;'"
                        role="progressbar"
                        x-init="setTimeout(() => showDetails = true, 500)">
                        <span 
                            x-text="result.final_rank"
                            class="animate-bounce"
                            x-show="showDetails"
                            x-transition:enter="transition ease-out duration-500"
                            x-transition:enter-start="opacity-0 scale-50"
                            x-transition:enter-end="opacity-100 scale-100"></span>
                    </div>
                    
                    <h2 class="card-title mt-4" x-show="showDetails" x-transition>
                        Á∑èÂêà„Çπ„Ç≥„Ç¢: <span x-text="result.aggregate_score.toFixed(1)"></span>ÁÇπ
                    </h2>
                    
                    <!-- ÂêàÊ†º/‰∏çÂêàÊ†º„É°„ÉÉ„Çª„Éº„Ç∏ -->
                    <template x-if="result.passed">
                        <div class="space-y-2" x-show="showDetails" x-transition>
                            <div class="badge badge-success badge-lg gap-2 p-4">
                                üéâ ÂêàÊ†º„É©„Ç§„É≥ÈÅîÊàêÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ
                            </div>
                            <p class="text-success font-medium">„ÅÇ„Å™„Åü„ÅÆÂä™Âäõ„ÅåÂÆü„ÇíÁµê„Å≥„Åæ„Åó„ÅüÔºÅ</p>
                        </div>
                    </template>
                    
                    <template x-if="!result.passed">
                        <div class="space-y-2" x-show="showDetails" x-transition>
                            <div class="badge badge-info badge-lg gap-2 p-4">
                                üìö „ÇÇ„ÅÜÂ∞ë„Åó„ÅßÂêàÊ†º„É©„Ç§„É≥„Åß„ÅôÔºÅ
                            </div>
                            <p class="text-info font-medium">
                                „ÅÇ„Å® <span x-text="getPointsToPass()" class="font-bold"></span> ÁÇπ„ÅßÂêàÊ†º„É©„Ç§„É≥ÔºÅ
                                <br>Ê¨°Âõû„ÅØ„Åç„Å£„Å®ÈÅîÊàê„Åß„Åç„Åæ„Åôüí™
                            </p>
                        </div>
                    </template>
                    
                    <!-- Ë©≥Á¥∞Ë°®Á§∫„Éú„Çø„É≥ -->
                    <button 
                        @click="showDetailedResult = !showDetailedResult"
                        class="btn btn-outline btn-sm mt-4"
                        x-show="showDetails">
                        <span x-text="showDetailedResult ? 'Ë©≥Á¥∞„ÇíÈö†„Åô ‚ñ≤' : 'Ë©≥Á¥∞„ÇíË¶ã„Çã ‚ñº'"></span>
                    </button>
                </div>
            </div>
            
            <!-- Ë®≠ÂïèÂà•Ë©ï‰æ° -->
            <div class="card bg-base-100 shadow-xl" x-show="showDetailedResult" x-transition>
                <div class="card-body">
                    <h3 class="card-title">Ë®≠ÂïèÂà•Ë©ï‰æ°</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Ë®≠Âïè</th>
                                    <th>„É©„É≥„ÇØ</th>
                                    <th>„Çπ„Ç≥„Ç¢</th>
                                    <th>ÊñáÂ≠óÊï∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(breakdown, question) in result.question_breakdown" :key="question">
                                    <tr>
                                        <td x-text="question"></td>
                                        <td>
                                            <span 
                                                class="badge"
                                                :class="getRankColorClass(breakdown.level)"
                                                x-text="breakdown.level">
                                            </span>
                                        </td>
                                        <td x-text="breakdown.question_score + 'ÁÇπ'"></td>
                                        <td x-text="breakdown.word_count + 'Â≠ó'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Ë¶≥ÁÇπÂà•Ë©ï‰æ° -->
            <template x-for="(breakdown, question) in result.question_breakdown" :key="question">
                <div class="card bg-base-100 shadow-xl" x-show="showDetailedResult" x-transition>
                    <div class="card-body">
                        <h3 class="card-title" x-text="question + '„ÅÆË©≥Á¥∞Ë©ï‰æ°'"></h3>
                        
                        <div class="space-y-3">
                            <template x-for="score in breakdown.criteria_scores" :key="score.criterion">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm font-medium" x-text="score.criterion"></span>
                                        <span class="text-sm" x-text="score.points + 'ÁÇπ'"></span>
                                    </div>
                                    <progress 
                                        class="progress w-full"
                                        :class="getProgressColor(score.points)"
                                        :value="score.points" 
                                        max="100">
                                    </progress>
                                    <template x-if="score.comment">
                                        <p class="text-xs text-base-content/70 mt-1" x-text="score.comment"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Âä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏ -->
            <div class="card bg-gradient-to-r from-primary/10 to-secondary/10 shadow-xl" x-show="showDetails" x-transition>
                <div class="card-body text-center">
                    <h3 class="card-title justify-center">üåü ‰ªäÊó•„ÅÆ‰∏ÄË®Ä</h3>
                    <p class="text-lg" x-text="getEncouragementMessage()"></p>
                </div>
            </div>
            
            <!-- Êàª„Çã„Éú„Çø„É≥ -->
            <div class="flex justify-center gap-4">
                <a href="/" class="btn btn-outline">Ë©¶È®ì‰∏ÄË¶ß„Å´Êàª„Çã</a>
                <button @click="retryExam()" class="btn btn-primary">
                    üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã
                </button>
            </div>
        </div>
    </template>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/result.js"></script>
{% endblock %}
